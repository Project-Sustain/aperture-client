<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
        integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
        integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
        crossorigin=""></script>
    <link rel="stylesheet" type="text/css" href="IframeStyle.css">
    <script src="Dependencies/leaflet-sidebar.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/leaflet-sidebar.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.css">
    <link rel="stylesheet" type="text/css" href="Dependencies/MarkerCluster.Default.css">
    <script src="Dependencies/leaflet.markercluster.js"></script>
</head>

<body>
    <!--Required for this map to be controlled-->
    <script>const MAPNUMBER = 2; //refers to whatever map in the grid this refers to</script>
    <script src="Dependencies/mouseDown.js"></script>
    <script>thisMapNumber = MAPNUMBER; //changes a variable in the mouseDown.js script</script>
    <!------------------------------------------>
    <div class="leaflet-bottom leaflet-left">
        <div class='queryInfo'>
            <div id='queryInfoText'>

            </div>
        </div>
    </div>
    <script>
        const MINRENDERZOOM = 12;
        let queryAlertText = document.getElementById('queryInfoText');
    </script>
    <script src="Dependencies/getInfrastructure.js"></script>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li>
                    <a href="#home" role="tab">
                        <img style="width:35px;height:35px;" src="../../images/hamburger-button.svg">
                    </a>
                </li>
            </ul>

        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    Water Infrastructure
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
                <div class="selectContainer">
                    <input type="checkbox" id="fountain" onchange="changeChecked(this)" checked>
                    <label for="fountain">Fountains</label><br>
                    <input type="checkbox" id="dam" onchange="changeChecked(this)" checked>
                    <label for="dam">Dams</label><br>
                    <input type="checkbox" id="water_tap" onchange="changeChecked(this)" checked>
                    <label for="water_tap">Water Taps</label><br>
                    <input type="checkbox" id="water_tower" onchange="changeChecked(this)" checked>
                    <label for="water_tower">Water Towers</label><br>
                    <input type="checkbox" id="water_well" onchange="changeChecked(this)" checked>
                    <label for="water_well">Water Wells</label><br>
                    <input type="checkbox" id="water_works" onchange="changeChecked(this)" checked>
                    <label for="water_works">Water Works</label><br>
                    <input type="checkbox" id="wastewater_plant" onchange="changeChecked(this)" checked>
                    <label for="wastewater_plant">Wastewater Plants</label><br>
                </div>
            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <!------------------------------------------>
    <div id='map2' class='map'></div>
    <script>
        osmMap2 = L.map('map2', {
            renderer: L.canvas(), minZoom: 3,
            fullscreenControl: true,
            inertia: false,
            timeDimension: false
        });

        osmMap2.on("load", function () {
            //-----------
        });

        osmMap2.setView(osmMap2.wrapLatLng(parent.view), parent.zoomLevel);


        var tiles2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 18,
            maxBounds: [[], []]
        }).addTo(osmMap2);
        
        var sidebar = L.control.sidebar('sidebar', {
            position: 'right'
        }).addTo(map);

        var markers = L.markerClusterGroup({
            showCoverageOnHover: false,
            spiderfyOnMaxZoom: false,
            disableClusteringAtZoom: 17,
            maxClusterRadius: 55
        });
        osmMap2.addLayer(markers);

        config(markers,osmMap2);
        var selectedObjects = [];

        /*
        infrastructure:
            to-do:
                waterway=spillway
                monitoring:groundwater
                waterway=lock gate
                man made=archimedes screw
                boundary=water_protection_area
                landuse=water_wellfield
                man_made=reservoir_covered
                landuse=reservoir
                man_made=pipeline  (additional tags for "underground", "sewage", and "water" have been proposed)
                landuse=basin
                landuse=reservoir
                natural=spring
                man made=monitoring station (can specify water)
                waterway=canal
                waterway=tidal_channel
                waterway=pressurised
                waterway=weir
            done:
                Here are all the available tags that I deemed potentially relevant. Please feel free to chip in with anything you think I've missed.
                amenity=fountain
                waterway=spillway
                amenity=drinking water
                man made=water well
                man made=water works
                man_made=wastewater_plant
                waterway=dam
                landuse=landfill
                man made=wastewater plant
                man_made=water_tower
        */

        function mapObjectGetter(objectName) {
            let query;
            let zoom;
            switch (objectName) {
                case "drinking_water":
                    query = 'amenity=drinking_water';
                    break;
                case "fountain":
                    query = 'amenity=fountain';
                    break;
                case "dam":
                    query = 'waterway=dam'
                    break;
                case "tap_water":
                    query = 'man_made=water_tap';
                    break;
                case "water_tower":
                    query = 'man_made=water_tower';
                    break;
                case "water_well":
                    query = 'man_made=water_well';
                    break;
                case "water_works":
                    query = 'man_made=water_works';
                    break;
                case "wastewater_plant":
                    query = 'man_made=wastewater_plant';
                    break;
                case "pipeline":
                    query = 'man_made=pipeline';
                    break;
                case "reservoir":
                    query = 'water=reservoir';
                    break;
                case "canal":
                    query = 'waterway=canal';
                    break;
                case "river":
                    query = 'waterway=river';
                    break;
                case "basin":
                    query = 'landuse=basin';
                    break;
            }
            return {
                query: query
            };
        }

        selectedObjects.push(mapObjectGetter("fountain"));
        selectedObjects.push(mapObjectGetter("dam"));
        selectedObjects.push(mapObjectGetter("tap_water"));
        selectedObjects.push(mapObjectGetter("water_tower"));
        selectedObjects.push(mapObjectGetter("water_well"));
        selectedObjects.push(mapObjectGetter("water_works"));
        selectedObjects.push(mapObjectGetter("wastewater_plant"));
        selectedObjects.push(mapObjectGetter("pipeline"));
        selectedObjects.push(mapObjectGetter("reservoir"));
        selectedObjects.push(mapObjectGetter("canal"));
        selectedObjects.push(mapObjectGetter("river"));
        //selectedObjects.forEach(object => osmMap2.addLayer(object));


        function updateOverPassLayer(map,reload) {
            updateObjects(selectedObjects, osmMap2.getBounds(), reload);
        }

        function removeOverpassLayer(map, removeLayer) {
            map.eachLayer(function (layer) {
                //console.log(layer.options);
                if (layer.options.id === "OverPassLayer" && layer.options.query == removeLayer.options.query) {
                    map.removeLayer(layer);
                }
            });
        }

        function changeChecked(element) {
            if (element.checked) {
                onCheck(element);
            }
            else {
                onUnchecked(element);
            }
        }

        function onCheck(element) {
            selectedObjects.push(mapObjectGetter(element.id));
            updateOverPassLayer(osmMap2,true);
        }

        function onUnchecked(element) {
            let idx;
            for (let i = 0; i < selectedObjects.length; i++) {
                if (selectedObjects[i].query.split('=')[1] == element.id) {
                    idx = i;
                    break;
                }
            }
            selectedObjects.splice(idx, 1);
            removeFromMap(element.id,markers,osmMap2);
        }

        parent.addEventListener('updateMaps', function () {
            runQuery();
        });

        function runQuery(){
            console.log(osmMap2.getCenter());
            if (osmMap2.getZoom() >= MINRENDERZOOM) {
                updateOverPassLayer(osmMap2,false);
            }
            else {
                queryAlertText.parentElement.style.display = "block";
                queryAlertText.innerHTML = "Current Zoom: " + osmMap2.getZoom() + " - Data at: " + MINRENDERZOOM;
                cleanupCurrentMap(osmMap2,markers);
            }
        }
        
        osmMap2.on("move", function (e) {
            parent.setGlobalPosition(osmMap2.getCenter(), MAPNUMBER);
        });
        osmMap2.on("zoomend", function () {
            parent.setGlobalPositionFORCE(osmMap2.getCenter(), MAPNUMBER);
        }); 
    </script>


    <!--You must add this map's setter function-->
    <script>
        var thisMapsSetter = function (view, zoom) {
            osmMap2.setView(osmMap2.wrapLatLng(parent.view), osmMap2.getZoom());
        }
        parent.setterFunctions.push({
            setterFunc: thisMapsSetter,
            mapNum: MAPNUMBER
        });
    </script>
</body>
